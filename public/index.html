<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezzo2 Multiplayer</title>
    <style>
        :root { --bg-color: #2c3e50; --square-light: #fdfdfd; --square-dark: #e0e0e0; --red-piece: #e74c3c; --blue-piece: #3498db; --highlight-selected: #ffd3b6; --highlight-move: #a8e6cf; --highlight-last: #dcedc1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: white; display:flex; flex-direction:column; align-items:center; height:100vh; margin:0; padding-top: 20px; }
        #lobby { display: flex; flex-direction: column; gap: 15px; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 8px; text-align: center; }
        #game-ui { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        #board-container { flex: 1; display:flex; justify-content:center; align-items:center; width:100%; box-sizing: border-box; padding: 10px; }
        #board { display: grid; gap: 1px; background: #34495e; border: 5px solid #34495e; width: 100%; max-width: 80vh; aspect-ratio: 1; }
        .square { display: flex; justify-content: center; align-items: center; cursor: pointer; background: var(--square-light); position:relative; }
        .square.dark { background: var(--square-dark); }
        .piece { width: 80%; height: 80%; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .piece.red { background: radial-gradient(circle at 30% 30%, #ff7675, #c0392b); }
        .piece.blue { background: radial-gradient(circle at 30% 30%, #74b9ff, #2980b9); }
        .selected { background: var(--highlight-selected) !important; }
        .last-move { background: var(--highlight-last) !important; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; border-radius: 4px; border:none; background: #27ae60; color: white; }
        button:hover { background: #2ecc71; }
        input { padding: 8px; border-radius: 4px; border: none; }
        #turn-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; background: #fff; color: #333; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="lobby">
        <h1>Rezzo2 Online</h1>
        <div>
            <label>Board Size:</label>
            <input type="number" id="size-in" value="13" min="9" max="19" style="width:50px;">
            <button onclick="createGame()">Create Game</button>
        </div>
        <hr style="width:100%; border:0; border-top:1px solid #555;">
        <div>
            <input type="text" id="join-id" placeholder="Game ID (e.g. A1B2)">
            <button onclick="joinGame()">Join Game</button>
        </div>
        <p style="font-size:0.8em; color:#aaa;" id="pid-display"></p>
    </div>

    <div id="game-ui">
        <div style="display:flex; justify-content:space-between; width: 90%; max-width: 600px; align-items: center;">
            <div id="game-info">Game ID: <span id="display-id" style="font-family:monospace; font-weight:bold; color:#f1c40f;"></span></div>
            <div id="turn-badge">Waiting...</div>
        </div>
        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>

<script>
    const socket = io();
    
    // Identity Management
    let playerId = sessionStorage.getItem('rezzo_pid');
    if (!playerId) {
        playerId = Math.random().toString(36).substring(2) + Date.now().toString(36);
        sessionStorage.setItem('rezzo_pid', playerId);
    }
    document.getElementById('pid-display').innerText = "Player Token: " + playerId.substring(0,6)+"...";

    let myColor = 0; // 0=Spectator, 1=Red, 2=Blue
    let boardData = [];
    let currentTurn = 1;
    let currentPhase = 0;
    let N = 13;
    let gameId = "";
    
    let selectedPos = null;
    let lastHighlights = [];

    // --- Networking ---

    function createGame() {
        const size = parseInt(document.getElementById('size-in').value);
        socket.emit('create_game', { size, playerId });
    }

    function joinGame() {
        let id = document.getElementById('join-id').value.toUpperCase();
        if(id) socket.emit('join_game', { gameId: id, playerId });
    }

    socket.on('connect', () => {
        if(gameId) {
            socket.emit('join_game', { gameId, playerId });
        }
    });

    socket.on('game_created', (data) => {
        setupGameUI(data.gameId, data.color, data.size, data.board);
    });

    socket.on('joined_game', (data) => {
        const enteredId = document.getElementById('join-id').value.toUpperCase();
        setupGameUI(enteredId || gameId, data.color, data.size, data.board);
    });

    socket.on('game_start', (data) => {
        boardData = data.board;
        currentTurn = data.turn;
        lastHighlights = data.highlights || [];
        updateUI();
    });

    socket.on('board_update', (data) => {
        boardData = data.board;
        currentTurn = data.turn;
        currentPhase = data.turnPhase || 0;
        lastHighlights = data.highlights || [];
        updateUI();
        
        if(data.gameOver) {
            const winnerName = data.winner === 1 ? "RED" : "BLUE";
            setTimeout(() => alert(`${winnerName} WINS!`), 100);
        }
    });

    socket.on('error', (msg) => {
        console.error(msg);
        if(msg !== "Game full" && msg !== "Not your turn" && msg !== "Spectators cannot play") alert("Error: " + msg);
        selectedPos = null;
        renderBoard();
    });

    // --- UI Logic ---

    function setupGameUI(id, color, size, initialBoard) {
        if(id) gameId = id;
        myColor = color;
        N = parseInt(size) || 13;
        
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('display-id').innerText = gameId || "Joined";
        
        boardData = initialBoard || Array(N).fill(0).map(()=>Array(N).fill(0));
        
        const boardEl = document.getElementById('board');
        boardEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
        boardEl.style.gridTemplateRows = `repeat(${N}, 1fr)`;
        
        updateUI();
    }

    function updateUI() {
        const badge = document.getElementById('turn-badge');
        
        if (myColor === 0) { // SPECTATOR
            badge.innerText = "SPECTATING";
            badge.style.background = "#95a5a6"; // Grey
            badge.style.color = "white";
        } else if (currentTurn === myColor) {
            if (currentPhase === 1) {
                badge.innerText = "YOUR TURN (Move 2/2)";
            } else {
                badge.innerText = "YOUR TURN";
            }
            badge.style.background = "#2ecc71"; // Green
            badge.style.color = "white";
        } else {
            badge.innerText = "OPPONENT'S TURN";
            badge.style.background = "#e74c3c"; // Red
            badge.style.color = "white";
        }
        renderBoard();
    }

    function renderBoard() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        
        // Spectators see standard view (Red at bottom)
        const isFlipped = (myColor === 2);
        
        for (let r_vis = 0; r_vis < N; r_vis++) {
            for (let c_vis = 0; c_vis < N; c_vis++) {
                let r, c;
                if (isFlipped) {
                    r = r_vis; 
                    c = (N - 1) - c_vis; 
                } else {
                    r = (N - 1) - r_vis; 
                    c = c_vis;
                }

                const sq = document.createElement('div');
                sq.className = `square ${(r+c)%2===0 ? 'dark' : ''}`;
                
                if (selectedPos && selectedPos.r === r && selectedPos.c === c) {
                    sq.classList.add('selected');
                }
                if (lastHighlights.some(h => h.r === r && h.c === c)) {
                    sq.classList.add('last-move');
                }

                const val = boardData[r][c];
                if (val !== 0) {
                    const p = document.createElement('div');
                    p.className = `piece ${val === 1 ? 'red' : 'blue'}`;
                    sq.appendChild(p);
                }

                sq.onclick = () => handleSquareClick(r, c);
                boardEl.appendChild(sq);
            }
        }
    }

    function handleSquareClick(r, c) {
        // Disable for Spectators (0) and Opponents
        if (myColor === 0 || currentTurn !== myColor) return; 

        const clickedVal = boardData[r][c];

        if (selectedPos && selectedPos.r === r && selectedPos.c === c) {
            selectedPos = null;
            renderBoard();
            return;
        }

        if (clickedVal === myColor) {
            selectedPos = {r, c};
            renderBoard();
            return;
        }

        if (selectedPos) {
            socket.emit('submit_move', {
                gameId,
                from: selectedPos,
                to: {r, c},
                playerId 
            });
            selectedPos = null;
            renderBoard();
        }
    }
</script>
</body>
</html>
